@model IList<URLBox.Application.ViewModel.UrlViewModel>
@using System.Collections.Generic
@using System.Linq
@using URLBox.Domain.Enums
@using URLBox.Application.ViewModel
@{
    Layout = null;
    var projects = (ViewBag.Projects as IEnumerable<ProjectViewModel> ?? Enumerable.Empty<ProjectViewModel>()).ToList();
    var manageableProjects = (ViewBag.ManageableProjects as IEnumerable<ProjectViewModel> ?? Enumerable.Empty<ProjectViewModel>()).ToList();
    var loginError = ViewBag.LoginError as string;
    var statusMessage = ViewBag.StatusMessage as string;
    var statusMessageTone = ((ViewBag.StatusMessageType as string) ?? "info").ToString().ToLowerInvariant();
    var loginReturnUrl = ViewBag.LoginReturnUrl as string ?? Url.Action("Index", "Home");
    var showLoginModal = (ViewBag.ShowLoginModal as bool?) ?? false;
    var shouldShowLoginModal = showLoginModal || !string.IsNullOrEmpty(loginError);
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var isAdmin = User.IsInRole("Administrator");
    var canManageUrls = (ViewBag.CanManageUrls as bool?) ?? false;
}

<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>@(ViewData["Title"] ?? "URL Box")</title>
    <script>
        const storedTheme = localStorage.getItem('urlbox-theme');
        if (storedTheme) {
            document.documentElement.setAttribute('data-bs-theme', storedTheme);
        }
    </script>
    <link rel="stylesheet" href="~/css/site.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>
    <div class="mobile-topbar d-lg-none">
        <button id="hamburgerBtn" class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#leftMenu" aria-controls="leftMenu" aria-label="Open menu">
            <i class="bi bi-list"></i>
        </button>
        <span class="fw-semibold">URL Box</span>
    </div>

    <aside id="leftSidebar" class="d-none d-lg-flex flex-column align-items-center gap-3">
        @if (isAdmin)
        {
            <a asp-controller="Admin" asp-action="Dashboard" class="btn btn-warning btn-icon" data-bs-placement="right" title="Admin dashboard">
                <i class="bi bi-speedometer"></i>
            </a>
        }

        @if (isAuthenticated)
        {
            <form asp-controller="Account" asp-action="Logout" method="post" class="m-0">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-secondary btn-icon" data-bs-placement="right" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </form>
        }
        else
        {
            <button type="button" class="btn btn-primary btn-icon" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-placement="right" title="Login">
                <i class="bi bi-person"></i>
            </button>
        }

        @if (canManageUrls)
        {
            <button type="button" class="btn btn-primary btn-icon" data-bs-toggle="modal" data-bs-target="#addUrlModal" data-bs-placement="right" title="Add URL">
                <i class="bi bi-plus-lg"></i>
            </button>
        }

        <button id="projectToggleDesktop" type="button" class="btn btn-outline-secondary btn-icon" data-bs-placement="right" title="Projects">
            <i class="bi bi-tag"></i>
        </button>
        @if (isAdmin)
        {
            <button type="button" class="btn btn-outline-secondary btn-icon" data-bs-toggle="modal" data-bs-target="#manageProjectsModal" data-bs-placement="right" title="Manage projects">
                <i class="bi bi-kanban"></i>
            </button>
        }
        <button id="themeToggleSidebar" type="button" class="btn btn-outline-secondary btn-icon" data-bs-placement="right" title="Dark mode">
            <i id="themeIconSidebar" class="bi bi-moon-fill"></i>
        </button>
        <a href="https://github.com/FindFara/URLBox" target="_blank" class="btn btn-dark btn-icon" data-bs-placement="right" title="GitHub repo">
            <i class="bi bi-github"></i>
        </a>
    </aside>

    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="leftMenu" aria-labelledby="leftMenuLabel">
        <div class="offcanvas-header">
            <h5 id="leftMenuLabel" class="mb-0">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column gap-3">
            @if (isAdmin)
            {
                <a asp-controller="Admin" asp-action="Dashboard" class="btn btn-warning w-100" data-bs-dismiss="offcanvas">
                    <i class="bi bi-speedometer me-1"></i> Admin dashboard
                </a>
                <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#manageProjectsModal" data-bs-dismiss="offcanvas">
                    <i class="bi bi-kanban me-1"></i> Manage projects
                </button>
            }

            @if (isAuthenticated)
            {
                <form asp-controller="Account" asp-action="Logout" method="post" class="d-grid">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-outline-secondary w-100" data-bs-dismiss="offcanvas">
                        <i class="bi bi-box-arrow-right me-1"></i> Logout
                    </button>
                </form>

                @if (canManageUrls)
                {
                    <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addUrlModal" data-bs-dismiss="offcanvas">
                        <i class="bi bi-plus-lg me-1"></i> Add URL
                    </button>
                }
            }
            else
            {
                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="offcanvas">
                    <i class="bi bi-person me-1"></i> Login
                </button>
            }

            <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="offcanvas" data-bs-target="#projectMenu" data-bs-dismiss="offcanvas">
                <i class="bi bi-tag me-1"></i> Projects
            </button>
            <button id="themeToggleMobile" type="button" class="btn btn-outline-secondary w-100">
                <i id="themeIconMobile" class="bi bi-moon-fill me-1"></i> Dark mode
            </button>
            <a href="https://github.com/FindFara/URLBox" target="_blank" class="btn btn-dark w-100">
                <i class="bi bi-github me-1"></i> GitHub
            </a>
        </div>
    </div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="projectMenu" aria-labelledby="projectMenuLabel">
        <div class="offcanvas-header">
            <h5 id="projectMenuLabel" class="mb-0">Projects</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column gap-3">
            @foreach (var project in projects)
            {
                <button type="button" class="btn btn-outline-primary w-100" onclick="filterByProject('@project.Name')" data-bs-dismiss="offcanvas">@project.Name</button>
            }
            <button type="button" class="btn btn-secondary w-100" onclick="filterByProject('all')" data-bs-dismiss="offcanvas">Show all</button>
        </div>
    </div>

    <div id="projectSidebar" class="flex-column gap-2">
        @foreach (var project in projects)
        {
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyProjectFilter('@project.Name')">@project.Name</button>
        }
        <button type="button" class="btn btn-secondary btn-sm" onclick="applyProjectFilter('all')">Show all</button>
    </div>

    @if (isAdmin)
    {
        <div class="modal fade" id="manageProjectsModal" tabindex="-1" aria-labelledby="manageProjectsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content shadow-sm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="manageProjectsModalLabel">Manage projects</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h6 class="fw-semibold">Add a new project</h6>
                        <form method="post" asp-action="AddProject" class="mb-4">
                            @Html.AntiForgeryToken()
                            <div class="input-group">
                                <input type="text" class="form-control" name="projectName" placeholder="Enter project name" required />
                                <button type="submit" class="btn btn-primary">Add</button>
                            </div>
                        </form>

                        <h6 class="fw-semibold">Existing projects</h6>
                        @if (manageableProjects.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead>
                                        <tr>
                                            <th scope="col">Project name</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var project in manageableProjects)
                                        {
                                            <tr>
                                                <td>
                                                    <form method="post" asp-action="UpdateProject" class="d-flex flex-wrap gap-2 align-items-center">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="projectId" value="@project.Id" />
                                                        <input type="text" name="projectName" value="@project.Name" class="form-control" required />
                                                        <button type="submit" class="btn btn-outline-primary btn-sm">Save</button>
                                                    </form>
                                                </td>
                                                <td class="text-end">
                                                    <form method="post" asp-action="DeleteProject" onsubmit="return confirm('Delete this project? This cannot be undone.');" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="projectId" value="@project.Id" />
                                                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                                    </form>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0" role="alert">
                                No projects are available yet.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @if (canManageUrls)
    {
        <div class="modal fade" id="addUrlModal" tabindex="-1" aria-labelledby="addUrlModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content shadow-sm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUrlModalLabel">Add new URL</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        @if (manageableProjects.Any())
                        {
                            <form method="post" asp-action="AddUrl">
                                @Html.AntiForgeryToken()
                                <div class="form-group mb-3">
                                    <label for="url">URL</label>
                                    <input type="url" class="form-control" id="url" name="url" placeholder="https://example.com" required />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="description">Description</label>
                                    <input type="text" class="form-control" id="description" name="description" placeholder="Enter description" required />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="project">Projects</label>
                                    <select class="form-select" id="project" name="projects" multiple required>
                                        @foreach (var project in manageableProjects)
                                        {
                                            <option value="@project.Name">@project.Name</option>
                                        }
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl (Windows) or Command (macOS) to select multiple projects.</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="environment">Environment</label>
                                    <select class="form-select" id="environment" name="environment">
                                        @foreach (EnvironmentType envType in Enum.GetValues(typeof(EnvironmentType)))
                                        {
                                            <option value="@envType">@envType</option>
                                        }
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label d-block">Visible to everyone?</label>

                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="isPublicYes" name="IsPublic" value="true" checked>
                                        <label class="form-check-label" for="isPublicYes">Yes</label>
                                    </div>

                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" id="isPublicNo" name="IsPublic" value="false">
                                        <label class="form-check-label" for="isPublicNo">No</label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Add URL</button>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-info mb-0" role="alert">
                                No projects are available for you to manage yet.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow-sm">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this URL?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="post" asp-action="DeleteUrl">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" id="deleteId" />
                        <button type="submit" class="btn btn-danger">Yes, delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow-sm">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(loginError))
                    {
                        <div class="alert alert-danger" role="alert">
                            @loginError
                        </div>
                    }
                    <form asp-controller="Account" asp-action="Login" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ReturnUrl" value="@loginReturnUrl" />
                        <div class="mb-3">
                            <label for="loginUserName" class="form-label">Username</label>
                            <input type="text" class="form-control" id="loginUserName" name="UserName" required autocomplete="username" />
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" name="Password" required autocomplete="current-password" />
                        </div>
                        <div class="form-check mb-3">
                            @Html.CheckBox("RememberMe", false, new { @class = "form-check-input", id = "loginRememberMe" })
                            <label class="form-check-label" for="loginRememberMe">Remember me</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert alert-@statusMessageTone alert-dismissible fade show" role="alert">
                @statusMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        <div class="row mt-4">
            @if (Model.Any())
            {
                @foreach (EnvironmentType envType in Enum.GetValues(typeof(EnvironmentType)))
                {
                    var urlsForEnvironment = Model.Where(u => u.Environment == envType).ToList();
                    if (!urlsForEnvironment.Any())
                    {
                        continue;
                    }
                    <div class="col-md-6 col-lg-3 mb-4">
                        <h4 class="text-primary">@envType</h4>
                        @foreach (var url in urlsForEnvironment)
                        {
                            var projectNames = (url.ProjectTags?.Any() ?? false)
                                ? url.ProjectTags
                                : new List<string> { "Unknown" };
                            var canManageEntry = canManageUrls && url.CanManage;
                            var dataProjects = string.Join("|", projectNames);
                            <div class="card p-2 mb-3 shadow-sm" data-projects="@dataProjects">
                                <h6 class="mb-1" style="color:var(--text-muted-strong);">
                                    @url.Description
                                    @foreach (var projectName in projectNames)
                                    {
                                        <span class="badge tag-badge">@projectName</span>
                                    }
                                    @if (url.IsPublic)
                                    {
                                        <span class="badge text-bg-success ms-2">Public</span>
                                    }
                                </h6>
                                <div class="input-group input-group-sm mb-2">
                                    <input type="text" class="form-control" value="@url.UrlValue" readonly />
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyToClipboard('@url.UrlValue')">Copy</button>
                                </div>
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    <a href="@url.UrlValue" target="_blank" class="btn btn-outline-secondary">Open</a>
                                    @if (canManageEntry)
                                    {
                                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal" onclick="setDeleteId(@url.Id)">
                                            Delete
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-info" role="alert">
                        No URLs available for your account yet.
                    </div>
                </div>
            }
        </div>
    </div>

    <footer class="footer">
        <h6>Fara.Co</h6>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function setDeleteId(id) {
            document.getElementById('deleteId').value = id;
        }

        function copyToClipboard(url) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => alert('URL copied to clipboard'))
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy URL. Please try again!');
                    });
            } else {
                const temp = document.createElement('textarea');
                temp.value = url;
                document.body.appendChild(temp);
                temp.select();
                try {
                    document.execCommand('copy');
                    alert('URL copied to clipboard');
                } catch (err) {
                    alert('Failed to copy URL. Please try again!');
                }
                document.body.removeChild(temp);
            }
        }

        (function () {
            const KEY = 'urlbox-theme';
            const htmlEl = document.documentElement;
            const toggles = [
                { btn: document.getElementById('themeToggleSidebar'), icon: document.getElementById('themeIconSidebar') },
                { btn: document.getElementById('themeToggleMobile'), icon: document.getElementById('themeIconMobile') }
            ].filter(x => x.btn && x.icon);

            const saved = localStorage.getItem(KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initial = saved || (prefersDark ? 'dark' : 'light');
            setTheme(initial);

            toggles.forEach(({ btn }) => btn.addEventListener('click', () => {
                const next = htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                setTheme(next);
            }));

            function setTheme(mode) {
                htmlEl.setAttribute('data-bs-theme', mode);
                localStorage.setItem(KEY, mode);
                toggles.forEach(({ icon }) => {
                    icon.classList.toggle('bi-moon-fill', mode !== 'dark');
                    icon.classList.toggle('bi-brightness-high-fill', mode === 'dark');
                });
            }

            const tipEls = [].slice.call(document.querySelectorAll('#leftSidebar [title]'));
            tipEls.forEach(el => new bootstrap.Tooltip(el));
        })();

        (function () {
            const ham = document.getElementById('hamburgerBtn');
            const offcanvasEl = document.getElementById('leftMenu');
            if (ham && offcanvasEl) {
                offcanvasEl.addEventListener('show.bs.offcanvas', () => ham.classList.add('invisible'));
                offcanvasEl.addEventListener('hidden.bs.offcanvas', () => ham.classList.remove('invisible'));
            }
        })();

        (function () {
            window.filterByProject = function (project) {
                document.querySelectorAll('.card[data-projects]').forEach(card => {
                    const projectsAttr = card.getAttribute('data-projects') || '';
                    const projectList = projectsAttr.split('|').map(p => p.trim()).filter(Boolean);
                    if (project === 'all' || projectList.includes(project)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            };

            window.applyProjectFilter = function (project) {
                filterByProject(project);
                const sidebar = document.getElementById('projectSidebar');
                if (sidebar) sidebar.classList.remove('show');
            };

            window.toggleProjectSidebar = function () {
                const sidebar = document.getElementById('projectSidebar');
                if (sidebar) sidebar.classList.toggle('show');
            };

            (function () {
                const projectBtn = document.getElementById('projectToggleDesktop');
                const sidebarEl = document.getElementById('projectSidebar');
                if (projectBtn && sidebarEl) {
                    projectBtn.addEventListener('mouseenter', () => {
                        const rect = projectBtn.getBoundingClientRect();
                        sidebarEl.style.top = rect.top + 'px';
                        sidebarEl.style.left = rect.right + 'px';
                        sidebarEl.classList.add('show');
                    });
                    projectBtn.addEventListener('mouseleave', () => {
                        setTimeout(() => {
                            if (!sidebarEl.matches(':hover') && !projectBtn.matches(':hover')) {
                                sidebarEl.classList.remove('show');
                            }
                        }, 100);
                    });
                    sidebarEl.addEventListener('mouseleave', () => {
                        if (!projectBtn.matches(':hover')) {
                            sidebarEl.classList.remove('show');
                        }
                    });
                }
            })();
        })();
    </script>
    @if (shouldShowLoginModal)
    {
        <script>
            const loginModalEl = document.getElementById('loginModal');
            if (loginModalEl) {
                const loginModal = new bootstrap.Modal(loginModalEl);
                loginModal.show();
            }
        </script>
    }
</body>
</html>
