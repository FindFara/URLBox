@model List<MyUrls.Models.UrlModel>
@using MyUrls.Models
@{
    Layout = null; /* Remove this line if you already use a shared _Layout */
}
<!doctype html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My URLs</title>
    <link rel="stylesheet" href="~/css/site.css" />
    <!-- Bootstrap 5.3 + Icons (remove if already included in _Layout) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

    <!-- Mobile hamburger (visible < lg) -->
    <button class="btn btn-outline-secondary btn-sm position-fixed d-lg-none hamburger-btn"
            type="button" data-bs-toggle="offcanvas" data-bs-target="#leftMenu"
            aria-controls="leftMenu" aria-label="Open menu">
        <i class="bi bi-list"></i>
    </button>

    <!-- Slim Left Sidebar (Desktop >= lg) -->
    <aside id="leftSidebar" class="d-none d-lg-flex flex-column align-items-center gap-3">
        <!-- Add -->
        <button type="button" class="btn btn-primary btn-icon"
                data-bs-toggle="modal" data-bs-target="#addUrlModal"
                data-bs-placement="right" title="Add">
            <i class="bi bi-plus-lg"></i>
        </button>
        <!-- Dark Mode -->
        <button id="themeToggleSidebar" type="button" class="btn btn-outline-secondary btn-icon"
                data-bs-placement="right" title="Dark mode">
            <i id="themeIconSidebar" class="bi bi-moon-fill"></i>
        </button>
        <!-- GitHub -->
        <a href="https://github.com/FindFara/Chamedoon" target="_blank"
           class="btn btn-dark btn-icon" data-bs-placement="right" title="GitHub repo">ٍ
            <i class="bi bi-github"></i>
        </a>
    </aside>

    <!-- Offcanvas Menu (Mobile) -->
    <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="leftMenu" aria-labelledby="leftMenuLabel">
        <div class="offcanvas-header">
            <h5 id="leftMenuLabel" class="mb-0">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column gap-3">
            <button type="button" class="btn btn-primary w-100"
                    data-bs-toggle="modal" data-bs-target="#addUrlModal" data-bs-dismiss="offcanvas">
                <i class="bi bi-plus-lg me-1"></i> Add
            </button>
            <button id="themeToggleMobile" type="button" class="btn btn-outline-secondary w-100">
                <i id="themeIconMobile" class="bi bi-moon-fill me-1"></i> Dark mode
            </button>
            <a href="https://github.com/FindFara/Chamedoon" target="_blank" class="btn btn-dark w-100">
                <i class="bi bi-github me-1"></i> GitHub
            </a>
        </div>
    </div>

    <!-- Modal for Adding URL -->
    <div class="modal fade" id="addUrlModal" tabindex="-1" aria-labelledby="addUrlModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow-sm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUrlModalLabel">Add New URL</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" asp-action="AddUrl">
                        <div class="form-group mb-3">
                            <label for="url">URL:</label>
                            <input type="text" class="form-control form-control-sm" id="url" name="url" placeholder="Enter URL" required />
                        </div>
                        <div class="form-group mb-3">
                            <label for="description">Description:</label>
                            <input type="text" class="form-control form-control-sm" id="description" name="description" placeholder="Enter description" required />
                        </div>
                        <div class="form-group mb-3">
                            <label for="tag">Tag:</label>
                            <select class="form-control form-control-sm" id="tag" name="tag" required>
                                <option value="آساپی">آساپی</option>
                                <option value="دایرکت دبیت">دایرکت دبیت</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="environment">Environment:</label>
                            <select class="form-control form-control-sm" id="environment" name="environment">
                                <option value="Dev">Dev</option>
                                <option value="Beta">Beta</option>
                                <option value="Stage">Stage</option>
                                <option value="Prod">Prod</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100">Add URL</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content shadow-sm">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this URL?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="post" asp-action="DeleteUrl">
                        <input type="hidden" name="id" id="deleteId" />
                        <button type="submit" class="btn btn-danger btn-sm">Yes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="container-fluid mt-4">
        <div class="row mt-4">
            @foreach (EnvironmentType envType in Enum.GetValues(typeof(EnvironmentType)))
            {
                <div class="col-md-6 col-lg-3 mb-4">
                    <h4 class="text-primary">@envType</h4>
                    @foreach (var url in Model.Where(u => u.Environment == envType))
                    {
                        <div class="card p-2 mb-3 shadow-sm">
                            <h6 class="mb-1" style="color:var(--text-muted-strong);">
                                @url.Description
                                <span class="badge tag-badge @(url.Tag == "آساپی" ? "bg-asapi" : "bg-directDebit")">@url.Tag</span>
                            </h6>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control" value="@url.Url" readonly />
                                <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('@url.Url')">Copy</button>
                            </div>
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <a href="@url.Url" target="_blank" class="btn btn-outline-secondary">Open</a>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmationModal" onclick="setDeleteId(@url.Id)">
                                    Delete
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <footer class="footer">
        <h6>Created by Fara</h6>
    </footer>

    <!-- Bootstrap JS (remove if already included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Delete id setter
        function setDeleteId(id) { document.getElementById('deleteId').value = id; }

        // Copy to clipboard
        function copyToClipboard(url) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => alert('URL copied to clipboard'))
                    .catch(err => { console.error('Failed to copy: ', err); alert('Failed to copy URL. Please try again!'); });
            } else {
                const temp = document.createElement('textarea');
                temp.value = url; document.body.appendChild(temp); temp.select();
                try { document.execCommand('copy'); alert('URL copied to clipboard'); }
                catch (err) { alert('Failed to copy URL. Please try again!'); }
                document.body.removeChild(temp);
            }
        }

        // Theme toggle logic (Sidebar + Mobile), persisted
        (function () {
            const KEY = 'preferred-bs-theme';
            const htmlEl = document.documentElement;

            const toggles = [
                { btn: document.getElementById('themeToggleSidebar'), icon: document.getElementById('themeIconSidebar') },
                { btn: document.getElementById('themeToggleMobile'), icon: document.getElementById('themeIconMobile') }
            ].filter(x => x.btn && x.icon);

            const saved = localStorage.getItem(KEY);
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initial = saved || (prefersDark ? 'dark' : 'light');
            setTheme(initial);

            toggles.forEach(({ btn }) => btn.addEventListener('click', () => {
                const next = htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
                setTheme(next); localStorage.setItem(KEY, next);
            }));

            function setTheme(mode) {
                htmlEl.setAttribute('data-bs-theme', mode);
                toggles.forEach(({ icon }) => {
                    icon.classList.toggle('bi-moon-fill', mode !== 'dark');
                    icon.classList.toggle('bi-brightness-high-fill', mode === 'dark');
                });
            }

            // Enable tooltips for sidebar icons
            const tipEls = [].slice.call(document.querySelectorAll('#leftSidebar [title]'));
            tipEls.forEach(el => new bootstrap.Tooltip(el));
        })();
    </script>
</body>
</html>
